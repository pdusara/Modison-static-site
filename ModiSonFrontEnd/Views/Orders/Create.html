<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Your Order</title>
    <link rel="stylesheet" href="../../wwwroot/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
</head>

<body>
    <header>
        <nav>
            <a href="../Home/Index.html">Home</a>
            <a href="Create.html">Order Now</a>
            <a
                href="https://modison-auth-domain.auth.us-east-1.amazoncognito.com/login?client_id=50cr96cieb5opojbgbetrpdq5t&response_type=token&scope=openid+profile+email&redirect_uri=https://d1p4pvkzpycf8v.cloudfront.net/Views/Home/index.html">Sign
                In</a>
            <a
                href="https://modison-auth-domain.auth.us-east-1.amazoncognito.com/logout?client_id=50cr96cieb5opojbgbetrpdq5t&logout_uri=https://d1p4pvkzpycf8v.cloudfront.net/Views/Home/index.html">Sign
                Out</a>
        </nav>
    </header>

    <p id="username"></p>

    <h2>Place Your Order</h2>
    <form id="orderForm" class="order-form">
        <label>Customer Name:</label>
        <input type="text" id="customerName" required />

        <label>Snack Name:</label>
        <select id="productList" name="SnackName"></select>

        <label>Quantity:</label>
        <input id="quantity" type="number" min="1" required />

        <button type="button" id="addItem">Add Item</button>
        <ul id="orderItems"></ul>

        <input type="hidden" id="ItemsJson" />

        <button type="submit">Submit Order</button>
    </form>

    <p id="orderStatus"></p>

    <footer>&copy; 2025 Modison UK</footer>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script>
        let authToken = null;
        let orderItems = [];

        async function fetchProducts() {
            if (!authToken) {
                console.error("User not authenticated.");
                return;
            }

            try {
                const response = await fetch("https://8f3bppntic.execute-api.us-east-1.amazonaws.com/api/products", {
                    headers: {
                        Authorization: `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const products = await response.json();
                const productList = document.getElementById("productList");
                productList.innerHTML = "";

                products.forEach(product => {
                    let option = document.createElement("option");
                    option.value = product.ProductName;
                    option.textContent = product.ProductName;
                    productList.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching products:", error);
                document.getElementById("orderStatus").textContent = "Access denied or session expired. Please log in again.";
            }
        }

        function handleAuthRedirect() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get("access_token");

            if (accessToken) {
                sessionStorage.setItem("access_token", accessToken);
                window.location.hash = ""; // Clean up the URL
            }

            authToken = sessionStorage.getItem("access_token");

            if (authToken) {
                const decoded = jwt_decode(authToken);
                const email = decoded.email || decoded.username || "User";
                document.getElementById("username").textContent = `Welcome, ${email}`;
                fetchProducts();
            } else {
                document.getElementById("username").textContent = "Not logged in";
            }
        }

        window.onload = handleAuthRedirect;
    </script>
</body>

</html>